{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">{{ page_title }}</h1>
                <div>
                    <a href="{% url 'task_detail' task_id %}" class="btn btn-outline-info me-2">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    <a href="{% url 'tasks' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Tasks
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Edit Task Configuration</h5>
                </div>
                <div class="card-body">
                    <div id="loadingSpinner" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading task data...</p>
                    </div>
                    
                    <form id="taskEditForm" style="display: none;">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskName" class="form-label">Task Name *</label>
                                    <input type="text" class="form-control" id="taskName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskPriority" class="form-label">Priority</label>
                                    <select class="form-select" id="taskPriority" name="priority">
                                        <option value="LOW">Low</option>
                                        <option value="NORMAL">Normal</option>
                                        <option value="HIGH">High</option>
                                        <option value="URGENT">Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="startUrl" class="form-label">Start URL *</label>
                            <input type="url" class="form-control" id="startUrl" name="start_url" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxPages" class="form-label">Max Pages to Visit</label>
                                    <input type="number" class="form-control" id="maxPages" name="max_pages" min="1" max="1000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="delay" class="form-label">Delay Between Actions (seconds)</label>
                                    <input type="number" class="form-control" id="delay" name="delay" min="0" max="60" step="0.5">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="takeScreenshots" name="take_screenshots">
                                <label class="form-check-label" for="takeScreenshots">
                                    Take Screenshots
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="detectCaptchas" name="detect_captchas">
                                <label class="form-check-label" for="detectCaptchas">
                                    Detect CAPTCHAs
                                </label>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Task
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button type="button" class="btn btn-danger" onclick="deleteTask()">
                                <i class="fas fa-trash"></i> Delete Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Task Information</h5>
                </div>
                <div class="card-body">
                    <div id="taskInfo">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const taskId = '{{ task_id }}';

// Load task data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTaskData();
});

async function loadTaskData() {
    try {
        const response = await fetch(`/api/frontend/tasks/${taskId}/`);
        if (response.ok) {
            const task = await response.json();
            populateForm(task);
            updateTaskInfo(task);
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('taskEditForm').style.display = 'block';
        } else {
            showAlert('danger', 'Error loading task data');
        }
    } catch (error) {
        showAlert('danger', 'Error loading task data: ' + error.message);
    }
}

function populateForm(task) {
    document.getElementById('taskName').value = task.name || '';
    document.getElementById('taskPriority').value = task.priority || 'NORMAL';
    document.getElementById('startUrl').value = task.start_url || '';
    document.getElementById('description').value = task.description || '';
    document.getElementById('maxPages').value = task.max_pages || 10;
    document.getElementById('delay').value = task.delay || 2;
    document.getElementById('takeScreenshots').checked = task.take_screenshots || false;
    document.getElementById('detectCaptchas').checked = task.detect_captchas || false;
}

function updateTaskInfo(task) {
    const taskInfo = document.getElementById('taskInfo');
    taskInfo.innerHTML = `
        <p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeClass(task.status)}">${task.status}</span></p>
        <p><strong>Created:</strong> ${new Date(task.created_at).toLocaleString()}</p>
        <p><strong>Last Updated:</strong> ${new Date(task.updated_at).toLocaleString()}</p>
        <p><strong>Pages Visited:</strong> ${task.total_pages_visited || 0}</p>
        <p><strong>Duration:</strong> ${task.duration || 'N/A'}</p>
    `;
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'PENDING': 'secondary',
        'RUNNING': 'primary',
        'COMPLETED': 'success',
        'FAILED': 'danger',
        'CANCELLED': 'warning',
        'PAUSED': 'info'
    };
    return statusClasses[status] || 'secondary';
}

// Form submission
document.getElementById('taskEditForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const taskData = Object.fromEntries(formData.entries());
    
    // Convert checkboxes to boolean
    taskData.take_screenshots = document.getElementById('takeScreenshots').checked;
    taskData.detect_captchas = document.getElementById('detectCaptchas').checked;
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(taskData)
        });
        
        if (response.ok) {
            showAlert('success', 'Task updated successfully!');
            loadTaskData(); // Reload data
        } else {
            const error = await response.json();
            showAlert('danger', 'Error updating task: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        showAlert('danger', 'Error updating task: ' + error.message);
    }
});

// Delete task
async function deleteTask() {
    if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        try {
            const response = await fetch(`/api/tasks/${taskId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                showAlert('success', 'Task deleted successfully!');
                setTimeout(() => {
                    window.location.href = '/tasks/';
                }, 1500);
            } else {
                const error = await response.json();
                showAlert('danger', 'Error deleting task: ' + (error.detail || 'Unknown error'));
            }
        } catch (error) {
            showAlert('danger', 'Error deleting task: ' + error.message);
        }
    }
}

// Reset form
function resetForm() {
    loadTaskData();
}

// Show alert
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
