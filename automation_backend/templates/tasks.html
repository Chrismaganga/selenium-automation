{% extends 'base.html' %}


{% block title %}Tasks - Selenium Automation Backend{% endblock %}

{% block page_title %}Task Management{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-primary" id="create-task-btn">
        <i class="fas fa-plus me-1"></i>Create Task
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="window.location.reload()">
        <i class="fas fa-sync-alt me-1"></i>Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Filters -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="task-search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="task-search" placeholder="Search tasks...">
                    </div>
                    <div class="col-md-2">
                        <label for="status-filter" class="form-label">Status</label>
                        <select class="form-select" id="status-filter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="running">Running</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="priority-filter" class="form-label">Priority</label>
                        <select class="form-select" id="priority-filter">
                            <option value="">All Priority</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quick Filters</label>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm filter-btn" data-filter='{"status": "running"}'>
                                Running
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm filter-btn" data-filter='{"status": "completed"}'>
                                Completed
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm filter-btn" data-filter='{"status": "failed"}'>
                                Failed
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tasks List -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>Tasks
                    <span class="badge bg-secondary ms-2" id="task-count">0</span>
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="exportTasks()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshTasks()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="tasks-container">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading tasks...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading tasks...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row mt-3">
    <div class="col-md-12">
        <nav aria-label="Task pagination">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="task-details-content">
                <!-- Task details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="edit-task-btn">Edit Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-task-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task-name" class="form-label">Task Name</label>
                                <input type="text" class="form-control" id="task-name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task-template" class="form-label">Template</label>
                                <select class="form-select" id="task-template" required>
                                    <option value="">Select Template</option>
                                    <option value="web_scraping">Web Scraping</option>
                                    <option value="form_filling">Form Filling</option>
                                    <option value="data_extraction">Data Extraction</option>
                                    <option value="monitoring">Monitoring</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task-url" class="form-label">Target URL</label>
                                <input type="url" class="form-control" id="task-url" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task-priority" class="form-label">Priority</label>
                                <select class="form-select" id="task-priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task-max-pages" class="form-label">Max Pages</label>
                                <input type="number" class="form-control" id="task-max-pages" value="10" min="1" max="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task-delay" class="form-label">Delay Between Requests (seconds)</label>
                                <input type="number" class="form-control" id="task-delay" value="2" min="0" max="60">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="task-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="task-notes" rows="3" placeholder="Optional notes about this task..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="task-headless" checked>
                                <label class="form-check-label" for="task-headless">
                                    Run in headless mode
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="task-screenshots">
                                <label class="form-check-label" for="task-screenshots">
                                    Take screenshots
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-task-btn">Create Task</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Task management specific JavaScript
$(document).ready(function() {
    // Initialize task manager
    if (typeof TaskManager !== 'undefined') {
        window.taskManager = new TaskManager();
    }
    
    // Create task form submission
    $('#save-task-btn').click(function() {
        createTask();
    });
    
    // Edit task button
    $('#edit-task-btn').click(function() {
        const taskId = $(this).data('task-id');
        if (taskId) {
            window.location.href = `/tasks/${taskId}/edit/`;
        }
    });
});

function clearFilters() {
    $('#task-search').val('');
    $('#status-filter').val('');
    $('#priority-filter').val('');
    
    if (window.taskManager) {
        window.taskManager.filters = {};
        window.taskManager.currentPage = 1;
        window.taskManager.loadTasks();
    }
}

function refreshTasks() {
    if (window.taskManager) {
        window.taskManager.loadTasks();
    }
}

function exportTasks() {
    // Implementation for exporting tasks
    UIUtils.showAlert('Export functionality coming soon', 'info');
}

async function createTask() {
    const formData = {
        name: $('#task-name').val(),
        template: $('#task-template').val(),
        url: $('#task-url').val(),
        priority: $('#task-priority').val(),
        max_pages: parseInt($('#task-max-pages').val()),
        delay_between_requests: parseInt($('#task-delay').val()),
        notes: $('#task-notes').val(),
        headless: $('#task-headless').is(':checked'),
        take_screenshots: $('#task-screenshots').is(':checked')
    };
    
    try {
        UIUtils.showLoading(true);
        const response = await api.createTask(formData);
        
        if (response.success) {
            UIUtils.showAlert('Task created successfully', 'success');
            $('#createTaskModal').modal('hide');
            $('#create-task-form')[0].reset();
            
            // Reload tasks
            if (window.taskManager) {
                window.taskManager.loadTasks();
            }
        } else {
            UIUtils.showAlert('Failed to create task: ' + (response.error.message || 'Unknown error'), 'danger');
        }
    } catch (error) {
        UIUtils.showAlert('Error creating task', 'danger');
        console.error('Create task error:', error);
    } finally {
        UIUtils.showLoading(false);
    }
}

async function openTaskDetails(taskId) {
    try {
        UIUtils.showLoading(true);
        const response = await api.getTask(taskId);
        
        if (response.success) {
            const task = response.data;
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${task.name || 'N/A'}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge ${UIUtils.getStatusBadgeClass(task.status)}">${task.status}</span></td></tr>
                            <tr><td><strong>Priority:</strong></td><td>${task.priority}</td></tr>
                            <tr><td><strong>Template:</strong></td><td>${task.template || 'Custom'}</td></tr>
                            <tr><td><strong>URL:</strong></td><td><a href="${task.url}" target="_blank">${task.url}</a></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Configuration</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Max Pages:</strong></td><td>${task.max_pages || 'N/A'}</td></tr>
                            <tr><td><strong>Delay:</strong></td><td>${task.delay_between_requests || 0}s</td></tr>
                            <tr><td><strong>Headless:</strong></td><td>${task.headless ? 'Yes' : 'No'}</td></tr>
                            <tr><td><strong>Screenshots:</strong></td><td>${task.take_screenshots ? 'Yes' : 'No'}</td></tr>
                            <tr><td><strong>Created:</strong></td><td>${UIUtils.formatDate(task.created_at)}</td></tr>
                        </table>
                    </div>
                </div>
                ${task.notes ? `<div class="mt-3"><h6>Notes</h6><p>${task.notes}</p></div>` : ''}
            `;
            
            $('#task-details-content').html(content);
            $('#edit-task-btn').data('task-id', taskId);
            $('#taskDetailsModal').modal('show');
        } else {
            UIUtils.showAlert('Failed to load task details', 'danger');
        }
    } catch (error) {
        UIUtils.showAlert('Error loading task details', 'danger');
        console.error('Task details error:', error);
    } finally {
        UIUtils.showLoading(false);
    }
}
</script>
{% endblock %}
